{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/ASUS/OneDrive/Documentos/Men%C3%BAs%20IA/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\r\nimport { cookies } from 'next/headers';\r\n\r\nexport async function createClient() {\r\n    const cookieStore = await cookies();\r\n\r\n    return createServerClient(\r\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n        {\r\n            cookies: {\r\n                getAll() {\r\n                    return cookieStore.getAll();\r\n                },\r\n                setAll(cookiesToSet) {\r\n                    try {\r\n                        cookiesToSet.forEach(({ name, value, options }) =>\r\n                            cookieStore.set(name, value, options)\r\n                        );\r\n                    } catch {\r\n                        // The `setAll` method was called from a Server Component.\r\n                        // This can be ignored if you have middleware refreshing sessions.\r\n                    }\r\n                },\r\n            },\r\n        }\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IAClB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGrB;QACI,SAAS;YACL;gBACI,OAAO,YAAY,MAAM;YAC7B;YACA,QAAO,YAAY;gBACf,IAAI;oBACA,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC1C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAErC,EAAE,OAAM;gBACJ,0DAA0D;gBAC1D,kEAAkE;gBACtE;YACJ;QACJ;IACJ;AAER"}},
    {"offset": {"line": 77, "column": 0}, "map": {"version":3,"sources":["file:///c:/Users/ASUS/OneDrive/Documentos/Men%C3%BAs%20IA/src/app/api/admin/stats/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\n\r\n// GET /api/admin/stats - Get dashboard statistics\r\nexport async function GET() {\r\n    try {\r\n        const supabase = await createClient();\r\n\r\n        // Get authenticated user\r\n        const { data: { user }, error: authError } = await supabase.auth.getUser();\r\n\r\n        if (authError || !user) {\r\n            return NextResponse.json(\r\n                { error: 'No autorizado' },\r\n                { status: 401 }\r\n            );\r\n        }\r\n\r\n        // Get user's tenant_id\r\n        const { data: userData, error: userError } = await supabase\r\n            .from('users')\r\n            .select('tenant_id')\r\n            .eq('id', user.id)\r\n            .single();\r\n\r\n        if (userError || !userData?.tenant_id) {\r\n            return NextResponse.json(\r\n                { error: 'Usuario sin restaurante asociado' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const tenantId = userData.tenant_id;\r\n\r\n        // Get current date info\r\n        const now = new Date();\r\n        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();\r\n        const weekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()).toISOString();\r\n        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n        // Parallel queries for all stats\r\n        const [\r\n            ordersTodayResult,\r\n            ordersWeekResult,\r\n            ordersMonthResult,\r\n            revenueTodayResult,\r\n            revenueWeekResult,\r\n            revenueMonthResult,\r\n            ordersByStatusResult,\r\n            topDishesResult,\r\n            recentOrdersResult,\r\n            ordersLast7DaysResult,\r\n        ] = await Promise.all([\r\n            // Orders count today\r\n            supabase\r\n                .from('orders')\r\n                .select('id', { count: 'exact', head: true })\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', todayStart),\r\n\r\n            // Orders count this week\r\n            supabase\r\n                .from('orders')\r\n                .select('id', { count: 'exact', head: true })\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', weekStart),\r\n\r\n            // Orders count this month\r\n            supabase\r\n                .from('orders')\r\n                .select('id', { count: 'exact', head: true })\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', monthStart),\r\n\r\n            // Revenue today\r\n            supabase\r\n                .from('orders')\r\n                .select('total')\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', todayStart)\r\n                .in('payment_status', ['paid', 'pending']),\r\n\r\n            // Revenue this week\r\n            supabase\r\n                .from('orders')\r\n                .select('total')\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', weekStart)\r\n                .in('payment_status', ['paid', 'pending']),\r\n\r\n            // Revenue this month\r\n            supabase\r\n                .from('orders')\r\n                .select('total')\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', monthStart)\r\n                .in('payment_status', ['paid', 'pending']),\r\n\r\n            // Orders by status\r\n            supabase\r\n                .from('orders')\r\n                .select('status')\r\n                .eq('tenant_id', tenantId),\r\n\r\n            // Top 5 dishes\r\n            supabase\r\n                .from('order_items')\r\n                .select(`\r\n                    dish_name,\r\n                    quantity,\r\n                    total_price,\r\n                    dish_id,\r\n                    orders!inner(tenant_id)\r\n                `)\r\n                .eq('orders.tenant_id', tenantId)\r\n                .order('quantity', { ascending: false })\r\n                .limit(10),\r\n\r\n            // Recent orders\r\n            supabase\r\n                .from('orders')\r\n                .select(`\r\n                    id,\r\n                    order_number,\r\n                    customer_name,\r\n                    total,\r\n                    status,\r\n                    created_at,\r\n                    order_items(count)\r\n                `)\r\n                .eq('tenant_id', tenantId)\r\n                .order('created_at', { ascending: false })\r\n                .limit(5),\r\n\r\n            // Orders per day (last 7 days)\r\n            supabase\r\n                .from('orders')\r\n                .select('created_at, total')\r\n                .eq('tenant_id', tenantId)\r\n                .gte('created_at', new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6).toISOString()),\r\n        ]);\r\n\r\n        // Calculate revenue\r\n        const calculateRevenue = (result: { data: { total: number }[] | null }) => {\r\n            return result.data?.reduce((sum, order) => sum + (Number(order.total) || 0), 0) || 0;\r\n        };\r\n\r\n        // Calculate orders by status\r\n        const byStatus = {\r\n            pending: 0,\r\n            confirmed: 0,\r\n            preparing: 0,\r\n            ready: 0,\r\n            delivered: 0,\r\n            cancelled: 0,\r\n        };\r\n        ordersByStatusResult.data?.forEach(order => {\r\n            if (order.status in byStatus) {\r\n                byStatus[order.status as keyof typeof byStatus]++;\r\n            }\r\n        });\r\n\r\n        // Calculate top dishes\r\n        const dishSales: Record<string, { name: string; quantity: number; revenue: number }> = {};\r\n        topDishesResult.data?.forEach(item => {\r\n            const name = item.dish_name;\r\n            if (!dishSales[name]) {\r\n                dishSales[name] = { name, quantity: 0, revenue: 0 };\r\n            }\r\n            dishSales[name].quantity += item.quantity;\r\n            dishSales[name].revenue += Number(item.total_price) || 0;\r\n        });\r\n        const topDishes = Object.values(dishSales)\r\n            .sort((a, b) => b.quantity - a.quantity)\r\n            .slice(0, 5);\r\n\r\n        // Calculate orders per day (last 7 days)\r\n        const ordersPerDay: { date: string; count: number; revenue: number }[] = [];\r\n        for (let i = 6; i >= 0; i--) {\r\n            const date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);\r\n            const dateStr = date.toISOString().split('T')[0];\r\n            const dayStart = date.toISOString();\r\n            const dayEnd = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1).toISOString();\r\n\r\n            const dayOrders = ordersLast7DaysResult.data?.filter(o => {\r\n                const orderDate = o.created_at;\r\n                return orderDate >= dayStart && orderDate < dayEnd;\r\n            }) || [];\r\n\r\n            ordersPerDay.push({\r\n                date: dateStr,\r\n                count: dayOrders.length,\r\n                revenue: dayOrders.reduce((sum, o) => sum + (Number(o.total) || 0), 0),\r\n            });\r\n        }\r\n\r\n        // Format recent orders\r\n        const recentOrders = recentOrdersResult.data?.map(order => ({\r\n            id: order.id,\r\n            order_number: order.order_number,\r\n            customer_name: order.customer_name,\r\n            total: order.total,\r\n            status: order.status,\r\n            created_at: order.created_at,\r\n            items_count: (order.order_items as { count: number }[])?.[0]?.count || 0,\r\n        })) || [];\r\n\r\n        return NextResponse.json({\r\n            orderStats: {\r\n                totalToday: ordersTodayResult.count || 0,\r\n                totalWeek: ordersWeekResult.count || 0,\r\n                totalMonth: ordersMonthResult.count || 0,\r\n                revenueToday: calculateRevenue(revenueTodayResult),\r\n                revenueWeek: calculateRevenue(revenueWeekResult),\r\n                revenueMonth: calculateRevenue(revenueMonthResult),\r\n                byStatus,\r\n                pending: byStatus.pending,\r\n                confirmed: byStatus.confirmed,\r\n                preparing: byStatus.preparing,\r\n                ready: byStatus.ready,\r\n                delivered: byStatus.delivered,\r\n                cancelled: byStatus.cancelled,\r\n            },\r\n            topDishes,\r\n            recentOrders,\r\n            ordersPerDay,\r\n        });\r\n    } catch (error) {\r\n        console.error('Unexpected error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Error interno del servidor' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}